var webpack = require('webpack')
var LodashModuleReplacementPlugin = require('lodash-webpack-plugin')
var path = require('path')
var utils = require('./utils')
var config = require('../config')
var vueLoaderConfig = require('./vue-loader.conf')

const modernizrOptions = {
  options: [
    'setClasses'
  ],
  'options': [
    'addTest',
    'atRule',
    'domPrefixes',
    'hasEvent',
    'html5shiv',
    'html5printshiv',
    'load',
    'mq',
    'prefixed',
    'prefixes',
    'prefixedCSS',
    'setClasses',
    'testAllProps',
    'testProp',
    'testStyles'
  ],
  'feature-detects': [
    'a/download',
    'ambientlight',
    'applicationcache',
    'audio',
    'audio/loop',
    'audio/preload',
    'audio/webaudio',
    'battery',
    'battery/lowbattery',
    'blob',
    'canvas',
    'canvas/blending',
    'canvas/todataurl',
    'canvas/winding',
    'canvastext',
    'contenteditable',
    'contextmenu',
    'cookies',
    'cors',
    'custom-elements',
    'crypto',
    'crypto/getrandomvalues',
    'css/all',
    'css/animations',
    'css/appearance',
    'css/backdropfilter',
    'css/backgroundblendmode',
    'css/backgroundcliptext',
    'css/backgroundposition-shorthand',
    'css/backgroundposition-xy',
    'css/backgroundrepeat',
    'css/backgroundsize',
    'css/backgroundsizecover',
    'css/borderimage',
    'css/borderradius',
    'css/boxshadow',
    'css/boxsizing',
    'css/calc',
    'css/checked',
    'css/chunit',
    'css/columns',
    'css/cssgrid',
    'css/cubicbezierrange',
    'css/displayrunin',
    'css/displaytable',
    'css/ellipsis',
    'css/escape',
    'css/exunit',
    'css/filters',
    'css/flexbox',
    'css/flexboxlegacy',
    'css/flexboxtweener',
    'css/flexwrap',
    'css/fontface',
    'css/generatedcontent',
    'css/gradients',
    'css/hairline',
    'css/hsla',
    'css/hyphens',
    'css/invalid',
    'css/lastchild',
    'css/mask',
    'css/mediaqueries',
    'css/multiplebgs',
    'css/nthchild',
    'css/objectfit',
    'css/opacity',
    'css/overflow-scrolling',
    'css/pointerevents',
    'css/positionsticky',
    'css/pseudoanimations',
    'css/pseudotransitions',
    'css/reflections',
    'css/regions',
    'css/remunit',
    'css/resize',
    'css/rgba',
    'css/scrollbars',
    'css/scrollsnappoints',
    'css/shapes',
    'css/siblinggeneral',
    'css/subpixelfont',
    'css/supports',
    'css/target',
    'css/textalignlast',
    'css/textshadow',
    'css/transforms',
    'css/transformslevel2',
    'css/transforms3d',
    'css/transformstylepreserve3d',
    'css/transitions',
    'css/userselect',
    'css/valid',
    'css/vhunit',
    'css/vmaxunit',
    'css/vminunit',
    'css/vwunit',
    'css/will-change',
    'css/wrapflow',
    'custom-protocol-handler',
    'customevent',
    'dart',
    'dataview-api',
    'dom/classlist',
    'dom/createElement-attrs',
    'dom/dataset',
    'dom/documentfragment',
    'dom/hidden',
    'dom/microdata',
    'dom/mutationObserver',
    'dom/passiveeventlisteners',
    'elem/bdi',
    'elem/datalist',
    'elem/details',
    'elem/output',
    'elem/picture',
    'elem/progress-meter',
    'elem/ruby',
    'elem/template',
    'elem/time',
    'elem/track',
    'elem/unknown',
    'emoji',
    'es5/array',
    'es5/date',
    'es5/function',
    'es5/object',
    'es5/specification',
    'es5/strictmode',
    'es5/string',
    'es5/syntax',
    'es5/undefined',
    'es6/array',
    'es6/collections',
    'es6/contains',
    'es6/generators',
    'es6/math',
    'es6/number',
    'es6/object',
    'es6/promises',
    'es6/string',
    'event/deviceorientation-motion',
    'event/oninput',
    'eventlistener',
    'exif-orientation',
    'file/api',
    'file/filesystem',
    'flash',
    'forms/capture',
    'forms/fileinput',
    'forms/fileinputdirectory',
    'forms/formattribute',
    'forms/inputnumber-l10n',
    'forms/placeholder',
    'forms/requestautocomplete',
    'forms/validation',
    'fullscreen-api',
    'gamepad',
    'geolocation',
    'hashchange',
    'hiddenscroll',
    'history',
    'htmlimports',
    'ie8compat',
    'iframe/sandbox',
    'iframe/seamless',
    'iframe/srcdoc',
    'img/apng',
    'img/crossorigin',
    'img/jpeg2000',
    'img/jpegxr',
    'img/sizes',
    'img/srcset',
    'img/webp',
    'img/webp-alpha',
    'img/webp-animation',
    'img/webp-lossless',
    'indexeddb',
    'indexeddbblob',
    'input',
    'input/formaction',
    'input/formenctype',
    'input/formmethod',
    'input/formtarget',
    'inputsearchevent',
    'inputtypes',
    'intl',
    'json',
    'ligatures',
    'lists-reversed',
    'mathml',
    'mediaquery/hovermq',
    'mediaquery/pointermq',
    'messagechannel',
    'network/beacon',
    'network/connection',
    'network/eventsource',
    'network/fetch',
    'network/xhr-responsetype',
    'network/xhr-responsetype-arraybuffer',
    'network/xhr-responsetype-blob',
    'network/xhr-responsetype-document',
    'network/xhr-responsetype-json',
    'network/xhr-responsetype-text',
    'network/xhr2',
    'notification',
    'pagevisibility-api',
    'performance',
    'pointerevents',
    'pointerlock-api',
    'postmessage',
    'proximity',
    'queryselector',
    'quota-management-api',
    'requestanimationframe',
    'script/async',
    'script/defer',
    'serviceworker',
    'speech/speech-recognition',
    'speech/speech-synthesis',
    'storage/localstorage',
    'storage/sessionstorage',
    'storage/websqldatabase',
    'style/scoped',
    'svg',
    'svg/asimg',
    'svg/clippaths',
    'svg/filters',
    'svg/foreignobject',
    'svg/inline',
    'svg/smil',
    'templatestrings',
    'textarea/maxlength',
    'touchevents',
    'typed-arrays',
    'unicode',
    'unicode-range',
    'url/bloburls',
    'url/data-uri',
    'url/parser',
    'url/urlsearchparams',
    'userdata',
    'vibration',
    'video',
    'video/autoplay',
    'video/crossorigin',
    'video/loop',
    'video/preload',
    'vml',
    'web-intents',
    'webanimations',
    'webgl',
    'webgl/extensions',
    'webrtc/datachannel',
    'webrtc/getusermedia',
    'webrtc/peerconnection',
    'websockets',
    'websockets/binary',
    'window/framed',
    'workers/blobworkers',
    'workers/dataworkers',
    'workers/sharedworkers',
    'workers/transferables',
    'workers/webworkers',
    'xdomainrequest'
  ]
}

function resolve (dir) {
  return path.join(__dirname, '..', dir)
}

module.exports = {
  entry: {
    app: './src/main.js',
    styles: [
      './node_modules/bootstrap/dist/css/bootstrap.min.css',
      './plugins/font-awesome/css/font-awesome.css',
      './plugins/jquery-scrollbar/jquery.scrollbar.css',
      './plugins/bootstrap-select2/select2.css',
      './plugins/switchery/css/switchery.min.css',
      './plugins/nvd3/nv.d3.min.css',
      './plugins/mapplic/css/mapplic.css',
      './plugins/rickshaw/rickshaw.min.css',
      './plugins/bootstrap-datepicker/css/datepicker3.css',
      './plugins/bootstrap3-wysihtml5/bootstrap3-wysihtml5.min.css',
      './plugins/bootstrap-tag/bootstrap-tagsinput.css',
      './plugins/dropzone/css/dropzone.css',
      './plugins/bootstrap-daterangepicker/daterangepicker-bs3.css',
      './plugins/bootstrap-timepicker/bootstrap-timepicker.min.css',
      './plugins/codrops-dialogFx/dialog.css',
      './plugins/codrops-dialogFx/dialog-sandra.css',
      './plugins/jquery-datatable/media/css/dataTables.bootstrap.min.css',
      './plugins/jquery-datatable/extensions/FixedColumns/css/dataTables.fixedColumns.min.css',
      './plugins/datatables-responsive/css/datatables.responsive.css',
      './plugins/jquery-dynatree/skin/ui.dynatree.css',
      './plugins/ion-slider/css/ion.rangeSlider.css',
      './plugins/ion-slider/css/ion.rangeSlider.skinFlat.css',
      './plugins/jquery-nouislider/jquery.nouislider.css',
      './plugins/pace/themes/blue/pace-theme-flash.css',
      './src/core/less/pages.less',
      './src/assets/less/style.less',

      './src/assets/less/custom.less'
    ]
  },
  output: {
    path: config.build.assetsRoot,
    filename: '[name].js',
    publicPath: process.env.NODE_ENV === 'production'
      ? config.build.assetsPublicPath
      : config.dev.assetsPublicPath
  },
  resolve: {
    extensions: ['.js', '.vue', '.json'],
    alias: {
      'vue$': 'vue/dist/vue.esm.js',
      'jquery': 'jquery/dist/jquery.js',
      modernizr$: resolve('empty-file.js'),
      'datatables': resolve('plugins/jquery-datatable/media/js/jquery.dataTables.min.js'),
      '@': resolve('src')
    },
    modules: ["./node_modules"]
  },
  resolveLoader: {
    modules: ["./node_modules"]
  },
  module: {

    rules: [
      /* {
       test: /\.(js|vue)$/,
       loader: 'eslint-loader',
       enforce: 'pre',
       exclude: [/\/node_modules\//, /\/plugins\//],
       include: [resolve('src'), resolve('test')],
       options: {
       formatter: require('eslint-friendly-formatter')
       }
       },*/
      {
        test: /\.vue$/,
        loader: 'vue-loader',
        options: vueLoaderConfig
      },

      {
        test: /\.js$/,
        exclude: [/\/node_modules\//, ],
        loader: 'babel-loader',
        options: {
          plugins: ['lodash']
        },
        include: [resolve('src'), resolve('test')]
      },
      {
        loader: 'webpack-modernizr-loader',
        options: modernizrOptions,
        test: /modernizr$/
      },
      {
        test: /modernizr/,
        loader: 'imports-loader?this=>window!exports-loader?window.Modernizr'
      },
      {
        test: /\.(png|jpe?g|gif|svg|cur)(\?.*)?$/,
        loader: 'url-loader',
        options: {
          limit: 10000,
          name: utils.assetsPath('img/[name].[hash:7].[ext]')
        }
      },
      {
        test: /\.(woff2?|eot|ttf|otf)(\?.*)?$/,
        loader: 'url-loader',
        options: {
          limit: 10000,
          name: utils.assetsPath('fonts/[name].[hash:7].[ext]')
        },

      }
    ]
  },
  plugins: [
    new webpack.ProvidePlugin({
      $: 'jquery',
      jquery: 'jquery',
      'window.jQuery': 'jquery',
      jQuery: 'jquery',
      //Modernizr: 'modernizr$'
    }),
    new LodashModuleReplacementPlugin
  ]
}
